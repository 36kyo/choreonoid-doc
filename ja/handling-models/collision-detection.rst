
干渉検出
========

モデルを動かしていると、リンクが他のリンクと干渉（衝突）を起こすことがあります。
Choreonoidはそのような干渉を検出する機能を備えており、ここではその利用法を説明します。

干渉検出とWorldアイテム
-----------------------

干渉検出を行うためには、まず「Worldアイテム」を導入する必要があります。

WorldアイテムはChoreonoid上でひとつの仮想世界(Virtual World)を表すアイテムです。
このアイテムによって、

* Bodyモデルをある仮想世界に結びつける
* 仮想世界全体の設定を行う
* 複数の仮想世界を同時に扱う

といったことが可能となります。

干渉検出においても、

* どの物体とどの物体の干渉を検出するか
* 干渉検出結果をどのように表示するか

といった設定が必要となりますが、これらはある仮想世界と結びつけることが合理的です。
そこで干渉検出の設定もWorldアイテムを介して行うようになっています。


Worldアイテムの作成
-------------------

Worldアイテムは、通常のアイテムの作成方法で作成することができます。
具体的には、メインメニューの「ファイル」-「新規」-「ワールド」を実行すると現れる
「新しいワールドアイテムの生成」ダイアログで「生成」ボタンを押して作成します。

Bodyモデルの関連付け
--------------------

Worldアイテムは、それにBodyモデルを関連付けることで初めて意味を成します。
関連付けは、BodyアイテムをWorldアイテムの小アイテムとして配置することで行います。

ここでは、今まで扱ってきたPA10のモデルでこれを行ってみましょう。
PA10モデルが読み込まれている状態で上記のWorldアイテムの作成を行うと、
アイテムツリービューでは２つのアイテムが以下のように並んで表示されているかと思います。

.. image:: images/pa10_and_world.png

ここで、"PA10"をマウスで"World"の上にドラッグすると、PA10がWorldの小アイテムに移動して以下のようになります。

.. image:: images/pa10_in_world.png

これでPA10モデルが仮想世界"World"と関連付けられました。
複数のBodyアイテムを関連付けたい場合も、同様にしてBodyアイテムを小アイテムとして追加していけばOKです。

.. note:: "PA10"が選択状態の時にWorldアイテムの生成を行うと、生成されたWorldアイテムはPA10の小アイテムとして配置されてしまい、親子関係が上の例とは逆になってしまいます。この場合はいったんWorldアイテムをアイテムツリービュー下部の何も無い領域にドラッグします。するとWorldアイテムがPA10の小アイテムでは無くなりますので、その後上記の操作を行うようにしてください。

.. note:: Worldアイテムを作成し、それを選択した状態でBodyモデルを読み込むと、モデルが最初からWorldアイテムの小アイテムとして読みこまれることになります。Worldアイテムを導入したプロジェクトを一から作成する際には、そのようにすることで操作を効率化できます。


干渉線の表示切り替え
--------------------

干渉検出の設定に入る前に、干渉検出結果を表示する方法について説明します。
Choreonoidでは干渉が検出された箇所に「干渉線」を表示することで、干渉検出結果を確認できるようになっています。
ただしこの表示は邪魔になる場合もあるため、デフォルトでは表示しないようになっています。

表示をオンにするためには、まず該当するWorldアイテムに関して、アイテムツリービュー上のチェックを入れます
（ :ref:`basics_itemtree_management` - :ref:`basics_selection_and_check` 参照）。
これで対応する仮想世界と関連する情報が表示される設定となります。
これまでのPA10の例では以下のようになります。

.. image:: images/pa10_in_world_checked.png

ただし、実際の表示のオン／オフはさらに表示を行うビューにも依存することになります。
シーンビュー上に干渉線を表示するためには、
:ref:`basics_sceneview_scenebar` の「干渉線の表示」ボタン（以下の図で赤枠で囲った部分）もオンにする必要があります。

.. image:: images/collision-toggle.png

これで表示に関する準備は完了です。
再度干渉線の表示を消したくなった場合は、上記のどちらかの項目をオフにしてください。


自己干渉の検出
--------------

Bodyモデル間の干渉検出
----------------------

.. image:: images/pa10_floor_in_world.png




