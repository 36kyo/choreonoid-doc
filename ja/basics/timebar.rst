
時間軸の操作
============

.. contents::
   :local:
   :depth: 1


仮想時間とタイムバー
--------------------

Choreonoid上では仮想的な時間軸が設定されており、
その現在時刻をユーザの操作によって変えることができます。
これによって、時間軸上の広がりを持つデータについて、
データの表示位置（時刻）を変えたり、
仮想時間を順次変化させていくことでアニメーション表示を行ったりすることができます。

そのような時間軸の操作を行うツールバーとして、
以下の「タイムバー」が用意されています。

.. image:: images/TimeBar.png

ここではこのタイムバーの操作を中心に、時間軸の操作について解説します。

時系列データ
------------

時間軸操作の対象となるのは、時間軸上の広がりを持つデータで、
一般的には「時系列データ」などと呼ばれます。
Choreonoidでは、時系列データに関してもその多くがアイテムとして定義されています。
具体的な時系列データアイテムの例としては、以下のようなものがあります。

======================== ===================================================
 アイテムクラス            概要
======================== ===================================================
 MultiValueSeqItem       浮動少数スカラ値の時系列データを複数格納するアイテム。ロボットの関節角軌道の格納等に用いられる。
 MultiSE3SeqItem         3次元位置・姿勢の時系列データを複数格納するアイテム。ロボットの各パーツ（リンク）の位置・姿勢の格納等に用いられる。
 Vector3SeqItem          3次元ベクトルの時系列データを格納するアイテム。重心位置、ZMP等の軌道の格納に用いられる。
 BodyMotionItem          Bodyモデル(ロボットや環境のモデル)全体の動作軌道を格納するアイテム。シミュレーション結果等が格納される。MultiValueSeqItem、MultiSE3SeqItem、Vector3SeqItem等からなる複合アイテムとして定義されている。
 PoseSeqItem             キーポーズの時系列を格納するアイテム。ロボット動作の振り付けで利用する。
 AudioItem               音声データを格納するアイテム。
 MediaItem               動画等のメディアデータを格納するアイテム。
======================== ===================================================

以下で説明するタイムバーの操作を試すために、何らかの時系列データアイテムを用意しておきましょう。
例えば :ref:`basics_project_sr1walk` で紹介したように、
SR1Walkプロジェクトを読み込んでシミュレーション開始ボタンを押すと、
シミュレーション結果が "AISTSimulator-SR1"というアイテムとして生成されます。
これは上に挙げた"BodyMotionItem"型のアイテムですので、
時間軸操作の対象とすることができます。


時系列データの関連付け
----------------------

時系列データの表示に関しては、時系列データそのものを直接表示する場合と、
時系列データのある時刻の内容で別のデータを更新し、
そのデータを介して間接的に時系列データの内容を確認する場合が考えられます。

例えばロボットの動作軌道データに関しては、
動作軌道そのものをグラフ等を用いて表示したり、
動作軌道の各時刻の関節角等の数値を表示する場合が前者に該当します。
一方、動作軌道の各時刻の関節角等の状態をロボットのモデルに適用し、
その際のロボットの姿勢を表示する、というのが後者に該当します。

どちらの場合も表示の仕方はアイテムやビューの種類によりますが、
後者の場合は何らかのかたちでデータ間の関連付けを行っておく必要があります。

関連付けは通常アイテムのツリー構造を用いて行われます。
ロボットモデルとその動作軌道データの場合、
BodyアイテムとBodyMotionアイテムがそれぞれに対応するアイテムです。
これらを関連付けるためには、BodyMotionアイテムがBodyアイテムの子アイテムとなっていればOKです。

例えば、SR1Walkのシミュレーションにおいて、アイテムツリーは以下のようになっています。

.. image:: images/ItemTreeView.png

ここでシミュレーション結果の"AISTSimulator-SR1"アイテムは
"SR1"アイテムの小アイテムとして生成されており、これによって両者の関連付けが行われていることが分かります。

ユーザが自分でデータを作成したり読み込んだりする際には、
このような関連付けのためのツリー構造となるよう各アイテムの配置を行ってください。

時系列データの選択
------------------

時系列データの表示に際しては、直接表示、関節表示いずれの場合も、
表示したいデータアイテムをアイテムツリービュー上で選択しておく必要がある場合があります。
これは、表示の候補となるデータアイテムが複数ある得る場合に、
どのアイテムを実際に表示するかを決定するために必要な操作となっています。

BodyMotionアイテムの例でも、アイテムの選択をしておく必要がありますので、その操作を行なってください。

.. note:: シミュレーション結果に関しては、シミュレータアイテム（SR1Walkサンプルでは "AISTSimulator" とあるアイテム）を選択しておけば、シミュレーション結果のBodyMotionアイテムが全て選択されているのと同じ意味になります。（シミュレーション直後はこの状態になっています。）この場合、シミュレートした仮想世界に含まれるモデルが複数ある場合でも、シミュレータアイテムをひとつ選択するだけで、全てのモデルの動作結果が表示されることになりますので、シミュレーション結果の表示においては通常この選択操作を行えばOKです。


時刻の表示と変更
----------------

Choreonoid上の仮想時間における現在時刻は、タイムバーの以下の領域に表示されます。単位は通常「秒」となります。

.. image:: images/timebar_time.png

また、この領域は値の入力もできるようになっており、値を入力することにより現在時刻を変更することも可能となっています。

時刻スライダ
------------

以下の時刻スライダの位置により、現在時刻を大まかに把握することができます。

.. image:: images/timeslider.png

また、このスライダをマウスでドラッグすることで、現在時刻を連続的に変化させることも可能です。
これに伴って時系列データの表示も連続的に更新されるので、
時系列データの各時刻の内容に変化がある場合、それがアニメーションとなって現れることになります。
従って、時刻スライダは手動でアニメーションを行うためのインタフェースにもなっています。


アニメーション再生
------------------

タイムバーの以下のボタンを使うことにより、自動のアニメーション再生を行うこともできます。

.. image:: images/play_buttons.png

２のボタンはどちらもアニメーションを開始するためのボタンですが、
左のボタンでは現在時刻がどこにあっても、時刻0から（正確にはタイムバーの最小時刻から）再生を開始します。
右のボタンの場合、現在時刻からの再生になります。

再生中は現在時刻が一定の速度で更新されていき、
実世界と同様の時間経過によるアニメーションを閲覧することができます。

アニメーションの再生中には、右のボタンの形状が以下のように変化します。

.. image:: images/play_stop_buttons.png

この時右のボタンは「再生停止」ボタンとなっており、このボタンを押すことで再生が停止します。
再生が停止すると、ボタンの機能が元に戻ります。

なお、再生に関する上記２つのボタンの機能は、ショートカットキーとしてそれぞれ"F5"キーと"F6"キーに割り当てられています。


時間範囲
--------

タイムバーの扱う時間の範囲は、以下の数値入力ボックスで設定することができます。

.. image:: images/timebar_range.png

左が最小時刻、右が最大時刻を表しており、時刻スライダの位置と時刻の関係もこの範囲によって変わります。
扱う時系列データの時間長が長い場合は、それに合わせてこの時間範囲も長めに設定しておきます。
ただし必要以上に長くすると、時刻スライダで有効な範囲が狭くなってしまい、
スライダを使った頭出しやアニメーションの操作がやりづらくなってしまうので、
対象データに合わせて適切な範囲に指定しておくことが推奨されます。


仮想時間の扱いに関する設定
--------------------------

タイムバーは以下の「設定」ボタンを備えています。

.. image:: images/timebar_config.png

このボタンを押すと、以下の設定ダイアログが表示され、
仮想時間の扱いに関する設定を行うことができます。

.. image:: images/timebar_config_dialog.png

設定項目は以下のようになっています。

======================================================================================================= =======================
 項目名                                                                                                 設定内容
======================================================================================================= =======================
 内部フレームレート                                                                                     Choreonoidの内部処理で使われる時間分解能を設定します。この値は、例えば動力学シミュレーションにおけるデルタタイムや、キーフレーム補間で生成される動作軌道のフレームレート等に用いられます。
 再生フレームレート                                                                                     アニメーション再生におけるフレームレートを設定します。対象データのフレームレートがこれより細かくても、アニメーションはこの分解能で行われることになります。（ただしこの値は最大のフレームレートで、描画等の処理にかかる時間によってはこの値よりも少ないフレームレートになる場合もあります。）
 アイドルループ駆動モード                                                                               このモードをオンにすると、再生フレームレートの設定によらず、余分なCPUパワーをアニメーション再生時のフレームレート向上に用いるようになります。
 再生スピード倍率                                                                                       アニメーション再生における速度を実時間の何倍にするかを設定します。デフォルトの1.0だと実世界と同じ速度の再生になりますが、2.0を設定すると２倍速の再生になります。
 進行中の更新に同期                                                                                     再生スピード倍率によらず、対象時系列データの更新速度に同期した再生にします。例えば、シミュレーションによって更新中の動作軌道を再生している場合、シミュレーションの計算速度に同期した再生となります。
 時間範囲の自動拡張                                                                                     アニメーション再生中に最大時刻に達した場合、最大時刻を更新しながらアニメーションを継続します。
======================================================================================================= =======================
