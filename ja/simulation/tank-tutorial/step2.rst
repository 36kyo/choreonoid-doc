
Step 2: コントローラの導入
==========================

.. contents:: 目次
   :local:
   :depth: 2

.. highlight:: C++



コントローラアイテムの生成
--------------------------

メインメニューの「ファイル」-「新規」から、使用するコントローラアイテム型を選択して生成します。生成したアイテムは、制御対象のボディアイテムの小アイテムとして配置します。あらかじめボディアイテムを選択してからコントローラアイテムを生成してもよいですし、生成後にこの配置になるようドラッグしてもOKです。この配置は、システムがコントローラアイテムの制御対象を特定するために必要な設定となっています。

今回の例では、「新規」メニューから「シンプルコントローラ」を選択してシンプルコントローラアイテムを生成し、下図のようにSR1アイテムの下に配置します。 ::

 [ ] - World
 [/]   + SR1
 [ ]     + SimpleController
 [/]   + Floor
 [ ]   + AISTSimulator


.. images/controller-project2.png

.. note:: シンプルコントローラアイテムを利用するためには、Choreonoidビルド時のCMakeオプションで"BUILD_SIMPLE_CONTROLLER_PLUGIN"がONになっている必要があります。（デフォルトではONになっています。）


コントローラ本体のセット
------------------------

コントローラアイテムにコントローラの本体をセットします。

シンプルコントローラアイテムの場合、「コントローラモジュール」というプロパティにコントローラ本体のファイル名を設定することで、これを行います。

なお、この指定においてディレクトリを省略しファイル名のみを記述すると、システム標準のディレクトリからファイルを検索します。標準ディレクトリは、 :doc:`../install/directories` で紹介した「プラグインディレクトリ」以下の "simplecontroller" というディレクトリになります。従って、コントローラ本体のファイルをここに格納しておけば、ファイル名だけでコントローラの指定ができます。また、".so"や".DLL"といった拡張子も省略可能です。拡張子を省略しておくことで、どのOSでも利用可能なプロジェクトとすることができます。

例として、SR1モデルを対象としたシンプルコントローラのサンプルである "SR1MinimumController" をセットしてみましょう。これはロボットの現在の姿勢を維持するだけの非常に単純なコントローラです。このコントローラのファイルがシステム標準のディレクトリに格納されていることを確認した上で、シンプルコントローラアイテムの「コントローラモジュール」プロパティに、"SR1MinimumController" を設定してください。

.. note:: サンプルコントローラは、Choreonoidビルド時にCMakeオプションで"BUILD_SIMPLE_CONTROLLER_SAMPLES"がONになっていると生成されます。（デフォルトではONになっています。）

.. note:: コントローラ本体のセット方法は、コントローラアイテムによって特に異なってくる部分です。本節で述べたコントローラ導入の基本的な流れを踏まえた上で、実際に使用するコントローラアイテムのドキュメントに従って設定を行ってください。例えばボディRTCアイテムの場合は、複数のRTコンポーネントを組み合わせてコントローラを構成することも可能ですが、コントローラのファイル名をひとつ指定するだけでこれを実現できるわけではなく、より複雑な設定が必要となってきます。

シミュレーションの実行
----------------------

以上の設定を行った上でシミュレーションを実行してください。設定がうまくできていれば、今度はロボットが崩れ落ちることなく姿勢を維持できるはずです。"SR1MinimumController" に記述されたPD制御のコードにより、姿勢を維持するためのトルク指令が各関節に出力されているからです。

うまくいかない場合は、メッセージビューも確認してみてください。コントローラの設定や稼働に問題があると、シミュレーション開始時にその旨を知らせるメッセージが出力される場合があります。

なお、コントローラがひとつだけ設定されたボディアイテムに対しては、 :ref:`simulation-result-item-output` はボディアイテムの小アイテムではなく、コントローラアイテムの小アイテムとなります。これはアイテムツリーを見やすくするためで、結果の再生等の操作はコントローラが無い場合と比べて特に変わるわけではありません。

コントローラのサンプルは他にも用意されています。 :ref:`basics_sample_project` を参考にして、他のサンプルも試してみてください。SR1モデルを対象としたサンプルとしては、歩行を行う "SR1Walk.cnoid" や、箱を持ち上げる "SR1Liftup.cnoid" といったプロジェクトがあり、コントローラによってロボットの動作が変わることを確認できます。
