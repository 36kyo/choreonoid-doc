ROS環境におけるChoreonoidの実行
===============================

ROSマスターの起動
-----------------

ROSのマスターを起動していない場合は、起動しておきます。（通常このための端末を新たに起動して、そこで実行します）。 ::

 roscore

Choreonoidの起動
----------------

Catkinワークスペース上でビルドした場合、上記のsetup.bashスクリプトにより、実行ファイルへのパスは通っている状態です。従って、ディレクトリのどこでも、単にchoreonoidと入力すればChoreonoidが起動します。 ::

 choreonoid

サンプルプロジェクトの実行
--------------------------

サンプルプロジェクトとして、choreonoid_ros_samples に含まれる "ROS-Tank" プロジェクトを実行してみましょう。

このサンプルは、ゲームパッドによってTankモデルを手動操作するというシミュレーションを、ROSの仕組みを用いて実現するというものです。このサンプルはこれを実現する最低限の実装となっており、ROSのjoyトピックをSubscribeするシンプルコントローラによってTankモデルの制御を行います。

ゲームパッドの準備
~~~~~~~~~~~~~~~~~~

サンプルの実行にあたっては、ゲームパッドがPCに接続されていて、その状態がROSのjoyトピックとして利用可能になっている必要があります。これは通常ROSが標準で備えているjoyパッケージで実現できますが、ここではそれをChoreonoid用にアレンジした"choreonoid_joy" パッケージを使用することにします。choreonoid_joyを使用することにより、joyメッセージの軸やボタンの情報がChoroenoid標準のマッピングに変換されるので、Choreonoidがサポートしている複数のゲームパッド機種に対して共通の軸やボタンを用いて操作できるという利点があります。具体的には、

* `ロジクールF310 <http://gaming.logicool.co.jp/ja-jp/product/f310-gamepad>`_
* `DUALSHOCK4 <http://www.jp.playstation.com/ps4/peripheral/cuhzct1j.html>`_
* DUALSHOCK3
* `Xbox用コントローラ <https://www.xbox.com/ja-JP/xbox-one/accessories/controllers/xbox-black-wireless-controller>`_
* Xbox360用コントローラ

などに対応しています。（なお、対応していない機種の場合、マッピングは異なってしまいますが、全く利用できないというわけではありません。）

choreonoid_joy パッケージは、 :doc:`build-choreonoid` の手順に従っていれば、お手元のROS環境で利用可能になっているはずです。使用するゲームパッドをPCに接続し、以下のコマンドを実行することで、choreonoid_joyによるjoyトピックが利用可能となります。 ::

 rosrun choreonoid_joy node

トピックが利用可能になっているかどうかは、rostopicコマンドを用いることで確認することができます。上記手順を実行後に、 ::

 rostopic echo /joy

を実行してください。

そこでゲームパッドの軸やボタンを操作すると、その度に ::

 header: 
   seq: 5972
   stamp: 
     secs: 1573371608
     nsecs: 462914906
   frame_id: ''
 axes: [0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0]
 buttons: [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
 ---

といった出力がされます。これがjoyトピックとしてpublishされているjoyメッセージの内容です。

ここの ::

 axes: [0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0]

の部分で各軸の傾きが分かりますし、 ::

 buttons: [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]

の部分で各ボタンの押し下げ状態が分かります。

ゲームパッドを適当に操作して、この情報の変化を確認できれば、joyトピックは利用可能となっています。

コマンド実行時にエラーが出る場合や、ゲームパッドを操作しても出力に変化が無い場合は、joyトピックが利用可能となっていませんので、ゲームパッドの接続やコマンド実行手順などについて確認するようにしてください。

プロジェクトの起動
~~~~~~~~~~~~~~~~~~

次に対象のプロジェクトファイルを読み込んでChoreonoidを起動します。

Cakin上でビルドした場合、サンプルのファイルは "catkin_ws/devel/share/choreonoid-1.8" 以下にインストールされます。choeonoid_ros_samples をビルドしていれば、このディレクトリに "ROS-Tank.cnoid" というプロジェクトファイルがあるはずです。

そこでまずこのディレクトリに ::

 cd ~/catkin_ws/devel/share/choreonoid-1.8

などとして移動して、 ::

 choreonoid ROS-Tank.cnoid

と入力することで、サンプルプロジェクトを起動できます。

あとはChoreonoidのシミュレーション開始ボタンを押して、シミュレーションを開始してください。するとゲームパッドでタンクモデルを操作することができます。
